---
title: "KEGG analysis"
output: 
  html_document:
    df_print: paged
author: "John Favate"
date: "`r Sys.time()`"
---

<style type="text/css">
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r warning = FALSE, message = FALSE}
# Prevent printing of warnings and such in the HTML
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
```

Read in packages and necessary data
```{r}
library(tidyverse)
library(clusterProfiler)

all.data <- read_csv("../../data_frames/all_data.csv")
```

Make deletions have fold change of -1
```{r}
fc.df.dels <- all.data %>%
  filter(gene_type == "ECB") %>% 
  select(line, target_id, ds_log2foldchange_rna, ds_log2foldchange_ribo, deleted) %>% 
  mutate(ds_log2foldchange_rna = ifelse(deleted == TRUE, -1, ds_log2foldchange_rna),
         ds_log2foldchange_ribo = ifelse(deleted == TRUE, -1, ds_log2foldchange_ribo))

fc.df <- all.data %>%
  filter(gene_type == "ECB") %>% 
  select(line, target_id, ds_log2foldchange_rna, ds_log2foldchange_ribo, deleted)
```

This requires a named vector where the elements of the vector are fold change in decreasing order and the names are the target_id's. This is done only on ECB type genes, i.e. protein coding, not tRNA or ERCC.
```{r}
fcs.vecs.dels <- fc.df.dels %>% 
  # only need these cols
  select(line, target_id, ds_log2foldchange_rna, ds_log2foldchange_ribo) %>%
  # reshape to be able to split by two things
  pivot_longer(., col = starts_with("ds_"), names_to = "seqtype", values_to = "l2fc") %>%
  # remove unnecessary string to leave just seqtype 
  mutate(seqtype = str_remove(seqtype, "ds_log2foldchange_")) %>%
  # split based on line/seqtype
  split(list(.$line, .$seqtype)) %>%
  map(function(x){
    # place in desc order
    df <- x %>%
      filter(!is.na(l2fc)) %>%
      arrange(desc(l2fc))
    
    # vec of fold changes  
    fcs <- pull(df, l2fc)
    
    # name that
    names(fcs) <- df$target_id
    
    return(fcs)
  })
```

Run the clusterprofiler function. 
```{r}
kegg.df.list.dels <- lapply(fcs.vecs.dels, function(x){
  gse <- gseKEGG(x,
                 organism = "ebr",
                 minGSSize = 2,
                 maxGSSize = 1000,
                 pvalueCutoff = 1,
                 eps = 0)
  
  return(as_tibble(gse))
})

#bind them all and separate the sample label
kegg.df.dels <- bind_rows(kegg.df.list.dels, .id = "sample") %>%
  separate(sample, into = c("line", "seqtype"), sep = "\\.")

# make the names lowercase
names(kegg.df.dels) <- tolower(names(kegg.df.dels))

write_csv(kegg.df.dels, "../../data_frames/table_s11_kegg_results.csv")
```

```{r}
sessionInfo()
```

