Gene finder

```{r}
library(tidyverse)
library(patchwork)
library(gridExtra)
library(rtracklayer)
library(ggrepel)

all.data <- read_csv("../../data_frames/all_data.csv")

gff <- readGFFAsGRanges("/data/john/projects/1ltee/gffs/AraR6.gff")

mutations <- read_csv("../../data_frames/LTEE-Ecoli-data 2020-05-04 15_18_48.csv")%>%
  mutate(clone_id = str_remove(strain, "REL")) %>%
  filter(population != "Ara+6")

my.clones <- c("11330","11392","11333","11342","11345","11364","11336","11348","11339","11367","11370","11389")

my.mutations <- mutations %>%
  filter(clone_id %in% my.clones & time == 50000)

anc.gff <- readGFFAsGRanges("../../gffs/AraR6.gff")
```

```{r}
my.mutations %>% 
  filter(population %in% c("Ara-5", "Ara+1"))
```


The colors for the operon membership on the x axis
```{r}
mycolors <- c("#ad0008","#392bab","#839000","#009590","#ca991b","#302974","#dc2b2a","#008746","#7e0025","#a0a569","#9a4f00")
```

mutator levels and colors
```{r}
mut.levels <- all.data %>%
  dplyr::select(line, mutator) %>%
  arrange(mutator, line) %>%
  unique() %>%
  pull(line)

mut.colors <- c("black", rep("black", 5), rep("firebrick3", 5))
```

The colors for the mutation plots
```{r}
snp.color <- "darkorchid"
del.color <- "orange2"
ins.color <- "forestgreen"
```


The following functions allow you to start with a vector of named genes where the elements of the vector are the names of the genes and the names of elements are operon membership. The actual names don't matter, so long as they are different strings.

### Make the heatmap

This takes a few arguments  
x = named vector of genes  
title = title you want the heatmap to have, appears as a facet  
threshold = min/max fold change to show, a positive integer   
fig_letter = the figure letter, like A, B, C, etc  
x_labs = a vector of x labels, namely for underlining purposes  
The legend that appears with this is for the bottom mutations on genes plots, but it has to be made here
```{r}
heatmap_function <- function(x, title, threshold, fig_letter, x_labs){
  # make a df that is keys for operons membership
  key.df <- enframe(x, value = "k12_name", name = "operon") %>% 
    mutate(graph_label = title)
  
  # find fcs for those genes
  fcdf <- all.data %>%
    filter(k12_name %in% x) %>%
    mutate(stars = ifelse(ds_padj_rna <= .01, "**", ifelse(ds_padj_rna <= .05, "*", ""))) %>%
    dplyr::select(line, k12_name, ds_log2foldchange_rna, stars) %>%
    left_join(., key.df, by = "k12_name")
  
  # change min/max fcs to the threshold
  fcdf$ds_log2foldchange_rna[fcdf$ds_log2foldchange_rna > threshold] <- threshold
  fcdf$ds_log2foldchange_rna[fcdf$ds_log2foldchange_rna < -threshold] <- -threshold
  
  # factor x and y axis
  fcdf$line <- factor(fcdf$line, levels = mut.levels)
  fcdf$k12_name <- factor(fcdf$k12_name, levels = x)
  
  # create the color vector for the x axis
  # both number of colors (length(rep.vec)) and n times to repeat each color
  rep.vec <- table(key.df$operon)
  
  # make a vector where each color repeats the correct amount of times
  color.vec <- sapply(1:length(rep.vec), function(y){
    rep(mycolors[y], rep.vec[y])
  }) %>% unlist()
  
  # randomly add one of the three mutation types to the df, this is only for the purpose
  # of making their be a color legend of the bottom graph, the layer is drawn underneath
  # the heatmap so you can't actually see it but the legend shows, which is the intended
  # effect. seed ensures all three show up,

  set.seed(1)

  mut.vec <- sample(c("Deletion", "SNP", "Insertional\nelement"), nrow(fcdf), replace = TRUE)
  
  # add that column
  fcdf$mtype <- mut.vec
  
  # new color bar labels
  scale.labels <- c(paste("\u2264", paste0("-", threshold), sep = ""),
                    "",
                    0,
                    "",
                    paste("\u2265", threshold, sep = ""))
  
  # finally, make a graph  
  plot <- fcdf %>%
    ggplot(., aes(k12_name, line, fill = ds_log2foldchange_rna, label = stars))+
    geom_point(aes(color = mtype))+
    geom_raster()+
    geom_text()+
    scale_fill_gradient2(low = "firebrick3", high = "dodgerblue3", 
                         name = expression(paste(log[2], "(fc)")),
                         limits = c(-3, 3),
                         guide = guide_colorbar(ticks.colour = "black"),
                         breaks = seq(-3, 3, 1.5),
                         labels = scale.labels)+
    theme(text = element_text(size = 13),
          axis.text.x = element_text(color = color.vec),
          axis.text.y = element_text(color = mut.colors),
          panel.background = element_blank(),
          axis.ticks = element_blank(),
          legend.key = element_blank())+
    labs(x = NULL,
         y = NULL,
         title = fig_letter)+
    facet_wrap(~ graph_label)+
    scale_x_discrete(labels = x_labs)+
    scale_color_manual(values = c(del.color, ins.color, snp.color), name = "Mutation type")
 
  return(plot) 
}
```

### Gene plots

The TFs
```{r}
genes <- c("rpoB", "rpoC", "rpoA", "rpoZ", "rpoD", "rpoS", "rpoN")

names(genes) <- genes
```

This function creates a list of data frames, each list element can be used to make a gene plot. It only requires a named vector of gene names like `c("argR")` where the names are the same as the vector.
```{r}
plot.df.list <- lapply(genes, function(x){
  ## gene position section
  # find start and stop pos of gene in ancestor
  gene.in.gff <- anc.gff[!is.na(anc.gff$Name) & anc.gff$Name == x & anc.gff$type == "CDS"]
  
  # make a data frame of this to make the rectangle on the plot
  gene.pos.df <- data.frame(starts = start(gene.in.gff),
                            ends = end(gene.in.gff),
                            gene = x)
  
  ## snps section
  # find all the snps positions, NA row ensures presence of a df if no snps present
  snp.pos.df <- my.mutations %>%
    filter(grepl(x, gene_list) & type == "SNP") %>%
    dplyr::select(population, start_position) %>%
    dplyr::rename("snp_pos" = start_position) %>%
    add_case(population = NA, snp_pos = NA)
  
  ## dels section
  # create the data frame for deletions, NA row ensures presence of a df if no dels present
  del.pos.df <- my.mutations %>%
    filter(grepl(x, gene_list) & (type == "DEL" | type == "INS")) %>%
    dplyr::select(population, start_position, end_position) %>%
    add_case(population = NA, start_position = NA, end_position = NA)
  
  ## mobile element section
  # create the data frame for insertional elements, NA row ensures presence of a df if no mobs present
  ins.pos.df <- my.mutations %>%
    filter(grepl(x, gene_list) & type == "MOB") %>%
    dplyr::select(population, start_position, end_position) %>%
    add_case(population = NA, start_position = NA, end_position = NA)
  
  return(list("gene.pos.df" = gene.pos.df, 
              "snp.pos.df" = snp.pos.df,
              "del.pos.df" = del.pos.df,
              "ins.pos.df" = ins.pos.df))
})
```

```{r}
rect.y.min <- -.25
rect.y.max <- .25
scale.y.min <- -1
scale.y.max <- 1.5

gene.plots <- lapply(plot.df.list, function(x){
  # in case you want to only label gene start stop
  xlabs <- c(x$gene.pos.df$starts, x$gene.pos.df$ends)
  
  gene.lab <- x$gene.pos.df$gene[1]
  
  ggplot()+
    geom_rect(data = x$del.pos.df, aes(xmin = start_position, xmax = end_position+3, ymin = rect.y.min, ymax = rect.y.max), fill = del.color, color = NA, alpha = .5)+
    geom_rect(data = x$ins.pos.df, aes(xmin = start_position, xmax = end_position+1, ymin = rect.y.min, ymax = rect.y.max), fill = ins.color, color = NA)+
    geom_segment(data = x$snp.pos.df, aes(x = snp_pos, xend = snp_pos, y = rect.y.min, yend = rect.y.max), color = snp.color)+
    geom_rect(data = x$gene.pos.df, aes(xmin = starts, xmax = ends, ymin = rect.y.min, ymax = rect.y.max), fill = NA, color = "black")+
    geom_text_repel(data = x$snp.pos.df, aes(label = population, x = snp_pos, y = rect.y.max), ylim = c(rect.y.max, scale.y.max), box.padding = .5, min.segment.length = .001, color = snp.color, segment.alpha = .5)+
    geom_text_repel(data = x$del.pos.df, aes(label = population, x = start_position, y = rect.y.min), ylim = c(rect.y.min, scale.y.min), box.padding = .5, min.segment.length = .001, color = del.color, segment.alpha = .5)+
    geom_text_repel(data = x$ins.pos.df, aes(label = population, x = start_position, y = rect.y.min), ylim = c(rect.y.min), box.padding = .5, min.segment.length = .001, color = ins.color, segment.alpha = .5)+
    theme(panel.background = element_blank(),
          axis.line.x = element_line(color = "black"),
          axis.ticks.y = element_blank(),
          axis.text.y = element_text(color = "black", size = 11))+
    scale_y_continuous(limits = c(-1, 1.5), breaks = 0, label = gene.lab)+
    scale_x_continuous(labels = scales::label_number(), breaks = scales::breaks_extended(2))+
    labs(x = "Base position in ancestor", y = NULL)
    
})

gene.plots
```

### genes

```{r}
iron <- c("fur",
          paste0("fhu", c("A", "C", "D", "B")),
          paste0("suf", c("A", "B", "C", "D", "S", "E")),
          "lpd",
          paste0("fep", c("D", "G", "C")),
          "relA",
          "spoT")

names(iron) <- c("fa",
                rep("fb", 4),
                rep("fc", 6),
                "fd",
                rep("fe", 3),
                "ff",
                "spoT")

iron.x.labs <- iron
```

```{r fig.width = 8, fig.height = 5}
pi.top <- heatmap_function(x = iron, title = "Iron transport", threshold = 3, fig_letter = "I", x_labs = iron.x.labs)

(pi <- (pi.top / gene.plots$spoT) + plot_layout(heights = c(.7, .3)))
```

```{r}
sigmas <- c("cbpB", "dnaA", "fis", "hfq", "H-NS", "hu", "iciA", "lrp", "stpA", "rpoS")

names(sigmas) <- sigmas

sigma.x.labs <- sigmas

ps.top <- heatmap_function(x = sigmas, title = "sigma", threshold = 3, fig_letter = "S", x_labs = sigma.x.labs)

(ps.top / gene.plots$rpoS) + plot_layout(heights = c(.7, .3))
```
why does rpoS have a fc if its deleted? 

```{r}
all.data %>% 
  filter(rel_name == "rpoS")
```

```{r}
library(rtracklayer)

gff.locs <- dir("../../gffs", full.names = TRUE)

x <- lapply(gff.locs, readGFFAsGRanges)
```

```{r}
lapply(x, function(y){
  as.data.frame(y[grepl("rpoS", y$Name) & y$type == "CDS"])
})
```

```{r}
x[[1]]
```

```{r}
my.mutations %>% 
  filter(grepl("rpoS", gene_list))
```

```{r}
my.mutations %>% 
  filter(type == "INS")
```

