---
title: "Figure S2"
output: 
  html_document:
    df_print: paged
author: "John Favate"
date: "`r Sys.time()`"
---

<style type="text/css">
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r}
# Prevent printing of warnings and such in the HTML
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
```

```{r}
library(tidyverse)
library(patchwork)
library(ggpubr)
library(ggpointdensity)
library(ggrepel)
```

The volume formula is $V = \frac{\pi W^2}{4}\left(L - \frac{W}{3}\right)$ where V = volume, W = width, L = length. As code, it's `volume = (pi/4)*(W^2)*(L-(W/3))`. Also add columns for mutator status and age.
```{r}
size.df <- read_csv("../../data_frames/table_s3_cell_size.csv") %>% 
  mutate(volume = (pi/4)*(SHAPE.width.mean^2)*(SHAPE.length-(SHAPE.length/3)),
         mutator = ifelse(line %in% c("Ara+6", "Ara+3", "Ara-4", "Ara-2", "Ara-1", "Ara-3"), TRUE, FALSE),
         age = ifelse(grepl("REL", line), "old", "young"),
         aspect_ratio = SHAPE.length / SHAPE.width.mean) %>% 
  filter(line != "Ara+6")

head(size.df)
```

### Panel A

Evolved lines have longer cells than ancestors, i.e. more chains. A boxplot of lengths.
```{r}
adf <- size.df %>%
  mutate(line = ifelse(grepl("REL", line), "Anc", line))

# Get the median ancestral volume for a dotted line
anc.median.length <- adf %>%
  filter(line == "Anc") %>%
  summarise(median.length = median(SHAPE.length, na.rm = TRUE)) %>%
  pull(median.length)

# factor the lines in anc, mut, non-mut order
mut.levels.b <- adf %>%
  select(line, mutator) %>%
  arrange(mutator, line) %>%
  unique() %>%
  pull(line)

adf$line <- factor(adf$line, levels = mut.levels.b)

# set mut colors for x axis labels
mut.colors.a <- c("black", rep("black", 6), rep("firebrick3", 5))

# get new x labs with the number 
newxlabs.volume <- adf %>%
  group_by(line) %>%
  tally() %>%
  ungroup() %>%
  mutate(newlab = paste0(line, "\n", n)) %>%
  pull(newlab)

# define the relationship between symbols and p values
symnum.args <- list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
                    symbols = c("****", "***", "**", "*", "ns"))

pa <- adf %>%
  mutate(fac = "All data") %>% 
  ggplot(., aes(line, SHAPE.length, fill = age))+
  geom_hline(aes(yintercept = anc.median.length), linetype = 5)+
  geom_boxplot(outlier.size = 1)+
  labs(x = NULL, 
       y = expression(paste("Length in ", mu, "m")),
       title = "A")+
  scale_x_discrete(labels = newxlabs.volume)+
  stat_compare_means(ref.group = "Anc", aes(label = ..p.signif..), symnum.args = symnum.args, method = "t.test")+
  theme(text = element_text(size = 13),
        panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.text.x = element_text(color = mut.colors.a))+
  scale_y_log10(limits = c(.6, 110))+
  annotation_logticks(sides = "l")+
  scale_fill_manual(values = c("orange3", "steelblue"), guide = FALSE)+
  facet_wrap(~fac)

pa
```

### Panel B

Even if we remove long cells, the evolved lines are larger than the ancestors. 
```{r}
# Get the median ancestral volume for a dotted line
anc.median.volume <- adf %>%
  filter(line == "Anc") %>%
  summarise(median.volume = median(volume, na.rm = TRUE)) %>%
  pull(median.volume)

bdf <- size.df %>%
  mutate(line = ifelse(grepl("REL", line), "Anc", line)) %>%
  group_by(line) %>% 
  mutate(median_vol = median(volume)) %>% 
  ungroup() %>% 
  filter(volume <= 3*median_vol)

# factor the lines in anc, mut, non-mut order
mut.levels.b <- bdf %>%
  select(line, mutator) %>%
  arrange(mutator, line) %>%
  unique() %>%
  pull(line)

bdf$line <- factor(bdf$line, levels = mut.levels.b)

# set mut colors for x axis labels
mut.colors.a <- c("black", rep("black", 6), rep("firebrick3", 5))

# get new x labs with the number 
newxlabs.volume <- bdf %>%
  group_by(line) %>%
  tally() %>%
  ungroup() %>%
  mutate(newlab = paste0(line, "\n", n)) %>%
  pull(newlab)

# define the relationship between symbols and p values
symnum.args <- list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
                    symbols = c("****", "***", "**", "*", "ns"))

pb <- bdf %>%
  mutate(fac = "Filaments removed") %>% 
  ggplot(., aes(line, volume, fill = age))+
  geom_hline(aes(yintercept = anc.median.volume), linetype = 5)+
  geom_boxplot(outlier.size = 1)+
  labs(x = NULL, 
       y = "Volume in fL",
       title = "B")+
  scale_x_discrete(labels = newxlabs.volume)+
  stat_compare_means(ref.group = "Anc", aes(label = ..p.signif..), symnum.args = symnum.args, method = "t.test")+
  theme(text = element_text(size = 13),
        panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.text.x = element_text(color = mut.colors.a))+
  scale_fill_manual(values = c("orange3", "steelblue"), guide = FALSE)+
  facet_wrap(~fac)

pb
```

### Panel C

Relationship between volume and a bunch of other parameters. Point being, big cells are usually long.
```{r fig.width = 14, fig.height = 4}
new.y.labs <- c("Aspect ratio", "Length (um)", "Width (um)")

names(new.y.labs) <- c("aspect_ratio", "SHAPE.length", "SHAPE.width.mean")

cdf <- size.df %>%
  mutate(newline = ifelse(grepl("REL", line), "Anc", line))

cdf$newline <- factor(cdf$newline, levels = c("Ancestor", mut.levels.b))

pc <- cdf %>%
  select(newline, age, volume, SHAPE.width.mean, aspect_ratio, SHAPE.length) %>%
  pivot_longer(cols = c(SHAPE.width.mean, SHAPE.length, aspect_ratio), names_to = "parameter", values_to = "parameter.in.um") %>%
  ggplot(., aes(volume, parameter.in.um))+
  geom_point(size = .5)+
  geom_smooth(method = "lm", se = FALSE, color = "firebrick1 ", size = .8)+
  scale_y_log10()+
  scale_x_log10()+
  facet_grid(parameter ~ newline, labeller = labeller(parameter = new.y.labs), scales = "free_y")+
  stat_cor(size = 2.75, label.y.npc = .04, label.x.npc = 1, aes(label = ..r.label..), hjust = "right")+
  theme_bw()+
  theme(panel.background = element_blank(),
        text = element_text(size = 13),
        panel.grid = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+
  labs(x = "Volume in fL",
       y = expression(paste("Parameter in indicated units")),
       title = "C")

pc
```

### Panel D

Showing the relationship between median size with filaments removed and total RNA per cfu. Get the median sizes with the large cells removed
```{r}
med.vols.sans.large.df <- size.df %>%
  group_by(line) %>% 
  mutate(median_vol = median(volume)) %>% 
  ungroup() %>% 
  filter(volume <= 3*median_vol) %>% 
  group_by(line) %>% 
  summarise(median_vol_sans_big = median(volume))
```

Get total RNA per cfu for each line/rep
```{r}
# import the dataset
mols.per.cfu.df <- read_csv("../../data_frames/table_s6_mRNAs_per_cfu.csv")

# find mean total rna per cfu for each line
mols.cfu.per.line <- mols.per.cfu.df %>%
  group_by(line, seqtype, repl) %>%
  summarise(total_rna_per_cfu = sum(n_mol_per_cfu)) %>%
  ungroup() %>% 
  group_by(line) %>% 
  summarise(rna = mean(total_rna_per_cfu))
```
Join the sizes and the above data
```{r fig.width = 4, fig.height = 4}
ddf <- left_join(med.vols.sans.large.df, mols.cfu.per.line, by = "line") %>% 
  mutate(mutator = ifelse(line %in% c("Ara-1", "Ara-2", "Ara-3", "Ara+3", "Ara-4"), "mut", "not"))

head(ddf)
```
Plot the relationship
```{r}
pd <- ddf %>% 
  ggplot(., aes(median_vol_sans_big, rna, label = line, color = mutator))+
  geom_smooth(method = "lm", inherit.aes = FALSE, aes(x = median_vol_sans_big, y = rna), se = FALSE, color = "black")+
  geom_point(size = 2.5)+
  geom_text_repel(min.segment.length = .00001, box.padding = .5, alpha = .5, seed = 1)+
  stat_cor(aes(x = median_vol_sans_big, y = rna), inherit.aes = FALSE, label.x.npc = .55, label.y.npc = .05)+
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        text = element_text(size = 13))+
  labs(x = "Median volume with filaments removed (fL)",
       y = "RNA per CFU",
       title = "D")+
  scale_color_manual(values = c("firebrick3", "black"), guide = FALSE)+
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  scale_x_continuous(limits = c(.5, 3.5))

pd
```

### Panel E

Comparison of replicates for total RNA per cfu.
```{r}
mols.per.cfu.df <- read_csv("/data/john/projects/2ltee/data_frames/table_s6_mRNAs_per_cfu.csv")

# Get median/mean sizes
avg.sizes <- size.df %>%
  group_by(line) %>%
  summarise(median_volume = median(volume, na.rm = TRUE),
            mean_volume = mean(volume),
            upper_quant = quantile(volume, .75),
            lower_quant = quantile(volume, .25)) %>%
  ungroup()

# Get total RNA per cfu for each line
mols.cfu.per.line <- mols.per.cfu.df %>%
  group_by(repl, line, seqtype) %>%
  summarise(total_rna_per_cfu = sum(n_mol_per_cfu)) %>%
  ungroup()

edf <- left_join(avg.sizes, mols.cfu.per.line, by = "line") %>%                                    #
  group_by(line, median_volume) %>%                                                                # for each line
  summarise(rna = mean(total_rna_per_cfu, na.rm = TRUE)) %>%                                       # find mean of total RNA per CFU between reps
  ungroup() %>%                                                                                    #
  mutate(mutator = ifelse(line %in% c("Ara-1", "Ara-2", "Ara-3", "Ara+3", "Ara-4"), "mut", "not")) # add mutator info

pe <- left_join(avg.sizes, mols.cfu.per.line, by = "line") %>% 
  pivot_wider(names_from = repl, values_from = total_rna_per_cfu) %>% 
  mutate(mutator = ifelse(line %in% c("Ara-1", "Ara-2", "Ara-3", "Ara+3", "Ara-4"), "mut", "not")) %>%
  ggplot(., aes(rep1, rep2, label = line, color = mutator))+
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), breaks = c(10^3, 10^4, 10^5, 10^6), limits= c(10^3, 10^6))+
  scale_x_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)), breaks = c(10^3, 10^4, 10^5, 10^6), limits= c(10^3, 10^6))+
  geom_point(size = 2.5)+
  geom_text_repel(min.segment.length = .00001, box.padding = .5, alpha = .5, seed = 1, segment.alpha = .5)+
  stat_cor(inherit.aes = FALSE, aes(x = rep1, y = rep2))+
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        text = element_text(size = 13))+
  labs(x = "Total RNA per CFU rep1",
       y = "Total RNA per CFU rep2",
       title = "E")+
  scale_color_manual(values = c("firebrick3", "black"), guide = FALSE)+
  geom_abline(aes(slope = 1 , intercept = 0), linetype = 5)

pe
```
### Panel F

A comparison between our data and data from a Lenski paper for which the raw data is not available, so this was estimated from figure 5.
```{r}
(fdf <- data.frame(line = c("REL606", "REL607", paste0("Ara-", 1:6), paste0("Ara+", 1:6)),
                  e_median_vol_L = c(.5, .5, 1.5, 2.2, 2.1, 2.7, 2.3, 1.6, 1.2, 1.9, 2.4, 1.8, 2, 2.7)) %>% 
  left_join(avg.sizes) %>% 
  mutate(mutator = ifelse(line %in% c("Ara-1", "Ara-2", "Ara-3", "Ara+3", "Ara-4"), "mut", "not")))
```

```{r}
pf <- ggplot(fdf, aes(median_volume, e_median_vol_L, label = line, color = mutator))+
  geom_point(size = 2.5)+
  geom_text_repel(min.segment.length = .0001, box.padding = 2, segment.alpha = .5, alpha = .5)+
  geom_errorbar(aes(xmax = upper_quant, xmin = lower_quant))+
  stat_cor(inherit.aes = FALSE, aes(median_volume, e_median_vol_L))+
  scale_x_continuous(limits = c(0, 4))+
  scale_y_continuous(limits = c(0, 4))+
  geom_abline(aes(slope = 1 , intercept = 0), linetype = 5)+
  theme_classic()+
  theme(text = element_text(size = 13))+
  labs(x = "Volume from this manuscript (fL)",
       y = "Volume from Grant et al. 2020",
       title = "F")+
  scale_color_manual(values = c("firebrick3", "black"), guide = FALSE)

pf
```


### Final figure

```{r fig.width = 13.5, fig.height = 12}
top <- (pa | pb)

bottom <- pd | pe | pf

(ff <- top / pc / bottom)
```

```{r}
ggsave(ff, filename = "../../figures/b_fig_s2.pdf", width = 13.5, height = 12)

ggsave(ff, filename = "../../figures/b_fig_s2.png", width = 13.5, height = 12, dpi = 300)
```

```{r}
sessionInfo()
```

