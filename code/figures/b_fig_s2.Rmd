---
title: "Figure S2"
output: 
  html_document:
    df_print: paged
author: "John Favate"
date: "`r Sys.time()`"
---

<style type="text/css">
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r}
# Prevent printing of warnings and such in the HTML
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
```

```{r}
library(tidyverse)
library(patchwork)
library(ggpubr)
library(ggpointdensity)
library(ggrepel)

size.df <- read_csv("../../data_frames/table_s3_cell_size.csv") %>%
  filter(line != "Ara+6") %>%
  mutate(length.in.um = SHAPE.length * .129,
         width.in.um = SHAPE.width * .129,
         aspect.from.um = length.in.um / width.in.um,
         mutator = ifelse(line %in% c("Aar+6", "Ara+3", "Ara-4", "Ara-2", "Ara-1", "Ara-3"), TRUE, FALSE))

head(size.df)
```

### Panel A

Evolved lines have longer cells than ancestors, i.e. more chains. A boxplot of lengths.
```{r}
adf <- size.df %>%
  mutate(line = ifelse(grepl("REL", line), "Anc", line))

# Get the median ancestral area for a dotted line
anc.median.length <- adf %>%
  filter(line == "Anc") %>%
  summarise(median.length = median(length.in.um, na.rm = TRUE)) %>%
  pull(median.length)

# factor the lines in anc, mut, non-mut order
mut.levels.b <- adf %>%
  select(line, mutator) %>%
  arrange(mutator, line) %>%
  unique() %>%
  pull(line)

adf$line <- factor(adf$line, levels = mut.levels.b)

# set mut colors for x axis labels
mut.colors.a <- c("black", rep("black", 6), rep("firebrick3", 5))

# get new x labs with the number 
newxlabs.area <- adf %>%
  group_by(line) %>%
  tally() %>%
  ungroup() %>%
  mutate(newlab = paste0(line, "\n", n)) %>%
  pull(newlab)

# define the relationship between symbols and p values
symnum.args <- list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
                    symbols = c("****", "***", "**", "*", "ns"))

pa <- adf %>%
  mutate(fac = "All data") %>% 
  ggplot(., aes(line, length.in.um, fill = age))+
  geom_hline(aes(yintercept = anc.median.length), linetype = 5)+
  geom_boxplot(outlier.size = 1)+
  labs(x = NULL, 
       y = expression(paste("Length in ", mu, "m")),
       title = "A")+
  scale_x_discrete(labels = newxlabs.area)+
  stat_compare_means(ref.group = "Anc", aes(label = ..p.signif..), symnum.args = symnum.args, method = "t.test")+
  theme(text = element_text(size = 13),
        panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.text.x = element_text(color = mut.colors.a))+
  scale_y_log10(limits = c(.6, 110))+
  annotation_logticks(sides = "l")+
  scale_fill_manual(values = c("orange3", "steelblue"), guide = FALSE)+
  facet_wrap(~fac)

pa
```

### Panel B

Even if we remove long cells, the evolved lines are larger than the ancestors. 
```{r}
# Get the median ancestral area for a dotted line
anc.median.area <- adf %>%
  filter(line == "Anc") %>%
  summarise(median.area = median(area.in.um, na.rm = TRUE)) %>%
  pull(median.area)

bdf <- size.df %>%
  mutate(line = ifelse(grepl("REL", line), "Anc", line)) %>%
  filter(area.in.um <= 3*anc.median.area)

# factor the lines in anc, mut, non-mut order
mut.levels.b <- bdf %>%
  select(line, mutator) %>%
  arrange(mutator, line) %>%
  unique() %>%
  pull(line)

bdf$line <- factor(bdf$line, levels = mut.levels.b)

# set mut colors for x axis labels
mut.colors.a <- c("black", rep("black", 6), rep("firebrick3", 5))

# get new x labs with the number 
newxlabs.area <- bdf %>%
  group_by(line) %>%
  tally() %>%
  ungroup() %>%
  mutate(newlab = paste0(line, "\n", n)) %>%
  pull(newlab)

# define the relationship between symbols and p values
symnum.args <- list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
                    symbols = c("****", "***", "**", "*", "ns"))

pb <- bdf %>%
  mutate(fac = "Filaments removed") %>% 
  ggplot(., aes(line, area.in.um, fill = age))+
  geom_hline(aes(yintercept = anc.median.area), linetype = 5)+
  geom_boxplot(outlier.size = 1)+
  labs(x = NULL, 
       y = expression(paste("Area in ", mu, "m"^2)),
       title = "B")+
  scale_x_discrete(labels = newxlabs.area)+
  stat_compare_means(ref.group = "Anc", aes(label = ..p.signif..), symnum.args = symnum.args, method = "t.test")+
  theme(text = element_text(size = 13),
        panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.text.x = element_text(color = mut.colors.a))+
  scale_y_continuous(limits = c(0, 3.5))+
  scale_fill_manual(values = c("orange3", "steelblue"), guide = FALSE)+
  facet_wrap(~fac)

pb
```

### Panel C

Relationship between area and a bunch of other parameters. Point being, big cells are usually long. Evo lines have increased chain forming tendency judging by aspect ratio and length increasing with area but not width. This makes it increasingly likely that for CFUs, each colony was not just one cell. 
```{r fig.width = 14, fig.height = 4}
new.y.labs <- c("Aspect ratio", "Length (um)", "Width (um)")

names(new.y.labs) <- c("aspect.from.um", "length.in.um", "width.in.um")

cdf <- size.df %>%
  mutate(newline = ifelse(grepl("REL", line), "Anc", line))

cdf$newline <- factor(cdf$newline, levels = c("Ancestor", mut.levels.b))

pc <- cdf %>%
  select(newline, age, area.in.um, width.in.um, aspect.from.um, length.in.um) %>%
  pivot_longer(cols = c(width.in.um, length.in.um, aspect.from.um), names_to = "parameter", values_to = "parameter.in.um") %>%
  ggplot(., aes(area.in.um, parameter.in.um))+
  geom_point(size = .5)+
  geom_smooth(method = "lm", se = FALSE, color = "firebrick1 ", size = .8)+
  scale_y_log10()+
  scale_x_log10()+
  facet_grid(parameter ~ newline, labeller = labeller(parameter = new.y.labs), scales = "free_y")+
  stat_cor(size = 2.75, label.y.npc = .04, label.x.npc = 1, aes(label = ..r.label..), hjust = "right")+
  theme_bw()+
  theme(panel.background = element_blank(),
        text = element_text(size = 13),
        panel.grid = element_blank())+
  labs(x = expression(paste("Area in ", mu, "m"^2)),
       y = expression(paste("Parameter in indicated units")),
       title = "C")

pc
```

### Panel D

The size scatterplots with individual replicates, and with and without filaments removed.

Correlation between size and molecules per cfu. Get median/mean sizes
```{r}
(avg.sizes <- size.df %>%
  group_by(line) %>%
  summarise(median_area = median(area.in.um, na.rm = TRUE),
            mean_area = mean(area.in.um)) %>%
  ungroup())
```

Get total RNA per cfu for each line/rep
```{r}
mols.per.cfu.df <- read_csv("../../data_frames/table_s6_mRNAs_per_cfu.csv")

mols.cfu.per.line <- mols.per.cfu.df %>%
  group_by(repl, line, seqtype) %>%
  summarise(total_rna_per_cfu = sum(n_mol_per_cfu)) %>%
  ungroup()
```

Join the sizes and the above data
```{r fig.width = 4, fig.height = 4}
all.data.df <- left_join(avg.sizes, mols.cfu.per.line, by = "line") %>% 
  mutate(mutator = ifelse(line %in% c("Ara-1", "Ara-2", "Ara-3", "Ara+3", "Ara-4"), "mut", "not")) %>%
  mutate(newlab = paste0(line, "-", repl),
         newlab = str_remove(newlab, "rep"))
```

For without filaments, we use the medians from all the data and remove entries that are larger than 3x the median in a line respective manner, then we recalculate the mean and median with those too large (presumably filamentous) entries removed. This doesn't alter the mean or median much, it seems. 
```{r}
small.avg.df <- size.df %>%
  left_join(., avg.sizes, by = "line") %>%
  mutate(too_big = ifelse(area.in.um > (3*median_area), TRUE, FALSE)) %>%
  filter(too_big == FALSE) %>%
  group_by(line) %>%
  summarise(median_area = median(area.in.um, na.rm = TRUE),
            mean_area = mean(area.in.um)) %>%
  ungroup()

sans.filaments <- left_join(small.avg.df, mols.cfu.per.line, by = "line") %>%
  group_by(line, repl) %>%
  summarise(median_area = mean(median_area),
            total_rna_per_cfu = mean(total_rna_per_cfu, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(newlab = paste0(line, "-", repl),
         newlab = str_remove(newlab, "rep"))
```

Join them and plot
```{r fig.width = 12, fig.height = 5}
new.facs <- c("all" = "All data",
              "sans" = "Filaments removed")

set.seed(2)

pd <- bind_rows("all" = all.data.df, "sans" = sans.filaments, .id = "type") %>%
  mutate(mutator = ifelse(line %in% c("Aar+6", "Ara+3", "Ara-4", "Ara-2", "Ara-1", "Ara-3"), TRUE, FALSE)) %>% 
  ggplot(., aes(median_area, total_rna_per_cfu, label = newlab, color = mutator))+
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  geom_point(size = 2.5)+
  geom_text_repel(min.segment.length = .00001, box.padding = .4, alpha = .5, seed = 1)+
  stat_cor(aes(label = ..r.label.., x = median_area, y = total_rna_per_cfu), inherit.aes = FALSE)+
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        text = element_text(size = 13))+
  labs(x = expression(paste("Median area (", mu, "m"^2, ")")),
       y = "RNA per CFU",
       title = "D")+
  scale_color_manual(values = c("black", "firebrick3"), guide = FALSE)+
  facet_wrap(~type, scales = "free", labeller = as_labeller(new.facs))

pd
```

### Final figure

```{r fig.width = 13, fig.height = 12}
top <- (pa | pb)

bottom <- (pd + plot_spacer())+ plot_layout(widths = c(.6, .4))

(ff <- top / pc / bottom)
```

```{r}
ggsave(ff, filename = "../../figures/b_fig_s2.pdf", width = 13, height = 12)

ggsave(ff, filename = "../../figures/b_fig_s2.png", width = 13, height = 12, dpi = 300)
```

```{r}
sessionInfo()
```

