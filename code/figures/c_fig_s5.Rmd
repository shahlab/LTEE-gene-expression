---
title: "Figure S5"
output: 
  html_document:
    df_print: paged
author: "John Favate"
date: "`r Sys.time()`"
---

<style type="text/css">
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r}
# Prevent printing of warnings and such in the HTML
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
```

```{r}
library(tidyverse)
library(gridExtra)
library(ggridges)
library(ggforce)
library(ggpubr)
library(patchwork)

all.data <- read_csv("../../data_frames/all_data.csv")

kdf <- read_csv("../../data_frames/table_s1_read_counts.csv")
```

Line order and colors for axis.
```{r}
mut.levels <- all.data %>%
  select(line, mutator) %>%
  arrange(mutator, line) %>%
  unique() %>%
  pull(line)

all.data$line <- factor(all.data$line, levels = mut.levels)

mut.colors <- c(rep("black", 6), rep("firebrick3", 5))
```

### Panel A

Correlations based on TPM
```{r}
adf <- kdf

mut.colors.a <- c(rep("black", 8), rep("firebrick3", 5))

mut.levels.a <- c("REL606", "REL607", mut.levels)
```

This performs line to line correlations based on log10(tpm). Genes with TPM of 0 would end up as Inf in the transformation, they are replaced with NA. It yields a list of two correlation matrices. 
```{r}
cor.mats <- adf %>%
  filter(grepl("ECB_", target_id)) %>% 
  group_by(seqtype, line, target_id) %>% 
  summarise(mean_tpm = mean(tpm)) %>%
  ungroup() %>% 
  split(.$seqtype) %>%
  map(function(x){
    # make a df suitable for running cor on
    df <- x %>%
      select(-seqtype) %>%
      mutate(mean_tpm = ifelse(mean_tpm != 0, log10(mean_tpm), NA)) %>% 
      pivot_wider(names_from = line, values_from = mean_tpm) %>%
      select(-target_id)
    
    # run line to line cors  
    cor.mat <- cor(df, use = "pairwise.complete.obs", method = "spearman")
  })

cor.mats
```

Half of each matrix is redundant, as is the diagonal. Make one matrix where the upper triangle is rna and the lower is ribo
```{r}
cor.combo <- cor.mats$ribo

cor.combo[upper.tri(cor.combo)] <- cor.mats$rna[upper.tri(cor.mats$rna)]

cor.combo
```

```{r}
cor.df <- cor.combo %>%
  as.data.frame() %>%
  rownames_to_column("line") %>%
  pivot_longer(cols = !line, names_to = "other_line", values_to = "rs") %>%
  filter(line != other_line)

cor.df$line <- factor(cor.df$line, levels = mut.levels.a)

cor.df$other_line <- factor(cor.df$other_line, levels = mut.levels.a)
```

You have to perform a visual inspection of which side is which, the upper left part of the line is RNAseq and the lower right of the line is riboseq.  
For example, upper tri is the matrix is RNAseq and has Ara-1 with the following cors, Ara-2=.9556596, Ara-3=9447084, these check out  
Lower tri is ribo in the matrix, it has Ara-1 with cors of, Ara-2=.9567913, Ara-3=.9473484, these check out
```{r fig.width = 12, fig.height = 5}
cor.df %>%
  ggplot(aes(line, other_line, fill = rs))+
  geom_raster()+
  scale_fill_viridis_c(option = "D",
                       na.value = "white",
                       name = expression(r[s]),
                       limits = c(.9, 1))+
  theme(panel.background = element_blank(),
        axis.ticks = element_blank(),
        text = element_text(size = 13),
        axis.text = element_text(color = mut.colors.a))+
  labs(x = NULL,
       y = NULL)+
  geom_abline(aes(slope = 1, intercept = 0))+
  geom_text(aes(label = round(rs, 7)))
```

No reason to show the whole number though
```{r fig.width = 8, fig.height = 6}
pa <- cor.df %>%
  ggplot(aes(line, other_line, fill = rs, label = signif(rs, 2)))+
  geom_raster()+
  geom_text()+
  scale_fill_viridis_c(option = "E",
                       na.value = "white",
                       name = expression(paste("Spearman's correlation of ", log[10], "(TPM)")),
                       limits = c(0,1),
                       breaks= c(0, .5, 1))+
  theme(panel.background = element_blank(),
        axis.ticks = element_blank(),
        text = element_text(size = 13),
        axis.text = element_text(color = mut.colors.a),
        legend.position = "bottom")+
  labs(x = NULL,
       y = NULL)+
  geom_abline(aes(slope = 1, intercept = 0))+
  labs(title = "A",
       x = "Ribo-seq",
       y = "RNA-seq")

pa
```

### Panel B

A second plot to show the difference between cors to the ancestor vs cors among evolved lines
```{r fig.width = 5, fig.height = 4}
bdf <- kdf %>%
  filter(grepl("ECB_", target_id)) %>% 
  group_by(seqtype, line, target_id) %>% 
  summarise(mean_tpm = mean(tpm)) %>%
  ungroup() %>% 
  split(.$seqtype) %>%
  map(function(x){
    # make a df suitable for running cor on
    df <- x %>%
      select(-seqtype) %>%
      mutate(mean_tpm = ifelse(mean_tpm != 0, log10(mean_tpm), NA)) %>% 
      pivot_wider(names_from = line, values_from = mean_tpm) %>%
      select(-target_id)
    
    # run line to line cors  
    cor.mat <- cor(df, use = "pairwise.complete.obs", method = "spearman")
    
    cor.mat[upper.tri(cor.mat)] <- NA
    
    cor.mat %>%
      as_tibble(rownames = "line") %>%
      pivot_longer(cols = starts_with("Ara"), names_to = "other_line", values_to = "rs") %>%
      filter(!is.na(rs) & line != other_line)
  }) %>%
  bind_rows(.id = "seqtype") %>%
  mutate(type = ifelse(line %in% c("REL606", "REL607") | other_line %in% c("REL606", "REL607"), "anc", "evo"))

bdf$seqtype <- factor(bdf$seqtype, levels = c("rna", "ribo"))

pb <- bdf %>% 
  ggplot(., aes(seqtype, rs, fill = type))+
  geom_boxplot(position = position_dodge(), alpha = .5, outlier.color = NA)+
  geom_jitter(position = position_jitterdodge(jitter.height = 0, jitter.width = .2), aes(color = type))+
  scale_y_continuous(limits = c(.9, 1))+
  stat_compare_means(method = "wilcox.test", label = "p.format")+
  theme_classic()+
  theme(text = element_text(size = 13),
        legend.position = "top")+
  scale_fill_manual(values = c("#50312F", "#cb6318"), name = NULL, labels = c("To ancestors", "Amongst evolved"))+
  scale_color_manual(values = c("#50312F", "#cb6318"), name = NULL, labels = c("To ancestors", "Amongst evolved"))+
  labs(x = NULL,
       y = expression(paste("Spearmans correlation of ", log[10], "(TPM)")),
       title = "B")+
  scale_x_discrete(labels = c("RNA-seq", "Ribo-seq"))

pb
```

### Panel C

Distribution of all fold changes instead of heatmap of all fold changes
```{r fig.width = 11, fig.height = 4}
cdf <- all.data %>%
  filter(gene_type == "ECB") %>%
  select(line, target_id, ds_log2foldchange_rna, ds_log2foldchange_ribo) %>%
  pivot_longer(cols = starts_with("ds_"), names_to = "seqtype", values_to = "l2fc")

cdf$line <- factor(cdf$line, levels = mut.levels)

cdf$seqtype <- factor(cdf$seqtype, levels = c("ds_log2foldchange_rna", "ds_log2foldchange_ribo"))

pc <- cdf %>%
  ggplot(., aes(line, l2fc, fill = seqtype))+
  geom_boxplot(outlier.size = .5)+
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        text = element_text(size = 13),
        axis.text.x = element_text(color = mut.colors),
        legend.position = c(.95, .15),
        legend.background = element_blank(),
        legend.key = element_blank())+
  labs(x = NULL,
       y = expression(paste(log[2], "(fold change)", sep = "")),
       title = "C")+
  scale_fill_discrete(labels = c("RNA-seq", "Ribo-seq"), name = NULL)+
  facet_zoom(ylim = c(-2,2), zoom.size = 1)

pc
```

### Final figure 

```{r results = "hide", message = FALSE, error = FALSE, warning = FALSE}
top <- grid.arrange(pa, pb, ncol = 2, widths = c(.65, .35))
```

```{r fig.width = 13, fig.height = 8}
(ff <- grid.arrange(top, pc, ncol = 1, heights = c(.6, .4)))
```

```{r}
ggsave(ff, filename = "../../figures/c_fig_s5.pdf", width = 13, height = 8)

ggsave(ff, filename = "../../figures/c_fig_s5.png", dpi = 300, width = 13, height = 8)
```

```{r}
sessionInfo()
```

