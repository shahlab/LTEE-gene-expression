---
title: "Figure 1"
output: 
  html_document:
    df_print: paged
author: "John Favate"
date: "`r Sys.time()`"
---

<style type="text/css">
.main-container {
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r}
# Prevent printing of warnings and such in the HTML
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
```

```{r}
library(tidyverse)
library(patchwork)
library(ggpubr)
library(ggpointdensity)
library(ggridges)
library(ggrepel)
library(png)
library(grid)
```

### Panel A

The schematic figure loaded as a png and then placed atop a graph of nothing. 
```{r}
png.a <- rasterGrob(readPNG("../../figures/b_schematic_figures.png"), interpolate = TRUE)

pa <- ggplot(mtcars, aes(hp, mpg))+
  annotation_custom(grob = png.a, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf)+
  labs(x = NULL, y = NULL, title = "A")+
  theme_void()+
  theme(text = element_text(size = 13))

pa
```

### Panel B

Boxplot of cell surface area. Load the size data and convert the pixel units to um.
```{r}
size.df <- read_csv("../../data_frames/table_s3_cell_size.csv") %>%
  filter(line != "Ara+6") %>%
  mutate(length.in.um = SHAPE.length * .129,
         width.in.um = SHAPE.width * .129,
         aspect.from.um = length.in.um / width.in.um,
         mutator = ifelse(line %in% c("Ara+6", "Ara+3", "Ara-4", "Ara-2", "Ara-1", "Ara-3"), TRUE, FALSE))

head(size.df)
```

```{r}
# the data frame for figure B
bdf <- size.df %>%
  mutate(line = ifelse(grepl("REL", line), "Anc", line),
         age = ifelse(line == "Anc", "old", "new"))

# Get the median ancestral area for a dotted line
anc.median.area <- bdf %>%
  filter(line == "Anc") %>%
  summarise(median.area = median(area.in.um, na.rm = TRUE)) %>%
  pull(median.area)

# factor the lines in anc, mut, non-mut order
mut.levels <- bdf %>%
  dplyr::select(line, mutator) %>%
  arrange(mutator, line) %>%
  unique() %>%
  pull(line)

bdf$line <- factor(bdf$line, levels = mut.levels)

# set mut colors for x axis labels
mut.colors.a <- c("black", rep("black", 6), rep("firebrick3", 5))

# get new x labs with the number of cells imaged
newxlabs.area <- bdf %>%
  group_by(line) %>%
  tally() %>%
  ungroup() %>%
  mutate(newlab = paste0(line, "\n", n)) %>%
  pull(newlab)

# define the relationship between symbols and p values
symnum.args <- list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
                    symbols = c("****", "***", "**", "*", "ns"))

pb <- bdf %>%
  ggplot(., aes(line, area.in.um, fill = age))+
  geom_hline(aes(yintercept = anc.median.area), linetype = 5)+
  geom_boxplot(outlier.size = 1, width = .7)+
  labs(x = NULL, 
       y = expression(paste("Area in ", mu, "m"^2)),
       title = "B")+
  scale_x_discrete(labels = newxlabs.area)+
  stat_compare_means(ref.group = "Anc", aes(label = ..p.signif..), symnum.args = symnum.args, method = "t.test")+
  theme(text = element_text(size = 13),
        panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        axis.text.x = element_text(color = mut.colors.a))+
  scale_y_log10(limits = c(.1, 112))+
  annotation_logticks(sides = "l")+
  scale_fill_manual(values = c("orange3", "steelblue"), guide = FALSE)

pb
```

Add the external images
```{r}
png.b <- rasterGrob(readPNG("../../figures/b_bac_images.png"), interpolate = TRUE)

(pb2 <- pb + annotation_custom(png.b, xmin = .55, xmax = 12.45, ymin = -1.7, ymax = 0))
```

### Panel C

Example linear model showing relationship between predicted number of ERCC added and it's TPM in the sample.
```{r}
ercc.df <- read_csv("../../data_frames/table_s5_ercc_molecules_per_sample.csv")

head(ercc.df)
```

Plot for a single line
```{r}
pc <- ercc.df %>%
  filter(line == "Ara+1" & seqtype == "rna") %>%
  ggplot(., aes(molecules_of_seq, tpm, color = repl))+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE)+
  stat_cor(aes(label = ..r.label..), show.legend = FALSE, label.x.npc = .01, label.y.npc = .99)+
  scale_y_log10(breaks = c(10^-2, 10^0, 10^2), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  scale_x_log10(breaks = c(1e3, 1e5, 1e7, 1e9), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        text = element_text(size = 13),
        legend.position = c(.85, .15),
        legend.key = element_blank(),
        legend.background = element_blank())+
  scale_color_manual(values = c("black", "grey50"),
                     name = NULL,
                     labels = c("Rep 1", "Rep 2"))+
  labs(y = "TPM",
       x = "Molecules of ERCC oligo added",
       title = "C")+
  facet_wrap(~line)

pc
```

### Panel D

Scatterplot of changes in absolute amounts. 
```{r}
mols.per.cfu.df <- read_csv("../../data_frames/table_s6_mRNAs_per_cfu.csv")

head(mols.per.cfu.df)
```

Compute an ancestral average molecules_per_cfu from the 4 ancestral samples.
```{r}
anc.means <- mols.per.cfu.df %>% 
  filter(line %in% c("REL606", "REL607")) %>% 
  group_by(target_id) %>% 
  summarise(anc_mean_mol_per_cfu = mean(n_mol_per_cfu))

head(anc.means)
```

The data frame for the plot, shows the average molecules per cfu for one line compared to that of the ancestors. 
```{r}
ddf <- mols.per.cfu.df %>% 
  filter(line == "Ara-1") %>% 
  group_by(line, target_id) %>% 
  summarise(mean_mol_per_cfu = mean(n_mol_per_cfu)) %>%
  left_join(anc.means, by = "target_id")

head(ddf)
```

Make the plot.
```{r fig.width = 3.5, fig.height = 3.5}
pd <- ddf %>% 
  ggplot(., aes(anc_mean_mol_per_cfu, mean_mol_per_cfu))+
  geom_abline(aes(slope = 1, intercept= 0), linetype = 5)+
  geom_pointdensity(size = 1)+
  scale_x_log10(limits = c(1e-4, 2e4), breaks = c(1e-3, 1e0, 1e3), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  scale_y_log10(limits = c(1e-4, 2e4), breaks = c(1e-3, 1e0, 1e3), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        text = element_text(size = 13))+
  labs(x = "Mean molecules/CFU in ancestor",
       y = "Mean molecules/CFU in evolved",
       title = "D")+
  facet_wrap(~line)+
  scale_color_viridis_c(option = "B",
                        name = "Neighboring\npoints",
                        guide = FALSE)+
  stat_cor(aes(label = ..r.label..))

pd
```

### Panel E

This panel will be a ridge lines plot showing the fold change in molecules per cfu between replicates, and also from each evolved line to the ancestors. First, get the number comparing replicates.
```{r}
rep.compares <- mols.per.cfu.df %>%                            #
  split(.$line) %>%                                            # for each line
  map(function(x){                                             #
    x %>%                                                      #
      select(line, repl, target_id, n_mol_per_cfu) %>%         # retain the columns
      pivot_wider(names_from = repl,                           # reshape the data
                  values_from = n_mol_per_cfu) %>%             #
      mutate(ratio = rep1/rep2) %>%                            # find ratio between replicates
      filter(!is.na(ratio) & !is.infinite(ratio) & ratio != 0) # keep non-zero numbers
  }) %>%
  bind_rows() %>%                                              # put them back together
  select(line, ratio)                                          # retain these rows                                          

head(rep.compares)
```

Next, find the ratio between the mean from the evolved lines to the mean of the ancestors.
```{r}
evo.to.anc.ratios <- mols.per.cfu.df %>%                      #
  filter(grepl("Ara", line)) %>% 
  group_by(line, target_id) %>%                               # for each gene in each line
  summarise(mean_mol_per_cfu = mean(n_mol_per_cfu)) %>%       # get the average of the two reps
  left_join(., anc.means) %>%                                 # add a col for ancestral mean
  mutate(ratio = mean_mol_per_cfu / anc_mean_mol_per_cfu) %>% # find the evo/anc ratio
  select(line, ratio) %>%                                     # retain these cols
  filter(!is.na(ratio) & !is.infinite(ratio) & ratio != 0)    # keep non-zero numbers

head(evo.to.anc.ratios)
```

Combine the replicates and evolved to ancestor comparison, adding mutator info in the process. 
```{r}
combo.df <- bind_rows("intrarep" = rep.compares, "evoanc" = evo.to.anc.ratios, .id = "comp")

head(combo.df)
```

Then make a graph
```{r}
# line order on y axis
combo.df$line <- factor(combo.df$line, levels = c("REL606", "REL607", mut.levels))

# mutator colors
mut.colors.d <- c(rep("black", 8), rep("firebrick3", 5))

# the plot
pe <- combo.df %>%
  ggplot(., aes(x = ratio, y = line, fill = comp))+
  geom_vline(aes(xintercept = 1), linetype = 5)+
  geom_density_ridges(scale = 1.1)+
  scale_x_log10(limits = c(1e-1, 1e3), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        text = element_text(size = 13),
        axis.text.y = element_text(color = mut.colors.d))+
  labs(x = "Fold change in molecules/CFU", 
       y = NULL,
       title = "E")+
  scale_fill_manual(values = c("#5F4B8BFF", "#E69A8DFF"),
                    name = NULL,
                    labels = c("Evolved/Ancestor", "Rep1/Rep2"),
                    guide = FALSE)

pe
```

### Panel F

Correlation between size and molecules per cfu. Get median/mean sizes
```{r}
(avg.sizes <- size.df %>%
  group_by(line) %>%
  summarise(median_area = median(area.in.um, na.rm = TRUE),
            mean_area = mean(area.in.um)) %>%
  ungroup() %>% 
   mutate(line = gsub("REL[67]", "REL", line)))
```

Get total RNA per cfu for each line
```{r}
mols.cfu.per.line <- mols.per.cfu.df %>%
  group_by(repl, line, seqtype) %>%
  summarise(total_rna_per_cfu = sum(n_mol_per_cfu)) %>%
  ungroup()
```

Join those and find the average between replicates. 
```{r fig.width = 4, fig.height = 4}
fdf <- left_join(avg.sizes, mols.cfu.per.line, by = "line") %>%                                    #
  group_by(line, median_area) %>%                                                                               # for each line
  summarise(rna = mean(total_rna_per_cfu, na.rm = TRUE)) %>%                                       # find mean of total RNA per CFU between reps
  ungroup() %>%                                                                                    #
  mutate(mutator = ifelse(line %in% c("Ara-1", "Ara-2", "Ara-3", "Ara+3", "Ara-4"), "mut", "not")) # add mutator info
```

Plot.
```{r}
set.seed(5)

pf <- fdf %>% 
  ggplot(., aes(median_area, rna, label = line, color = mutator))+
  scale_y_log10(labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  geom_point(size = 2.5)+
  geom_text_repel(min.segment.length = .00001, box.padding = .5, alpha = .5, seed = 1)+
  stat_cor(aes(label = ..r.label.., x = median_area, y = rna), inherit.aes = FALSE)+
  theme(panel.background = element_blank(),
        axis.line = element_line(color = "black"),
        text = element_text(size = 13))+
  labs(x = expression(paste("Median area (", mu, "m"^2, ")")),
       y = "RNA per CFU",
       title = "F")+
  scale_color_manual(values = c("firebrick3", "black"), guide = FALSE)

pf
```

### Final figure

```{r fig.width = 15, fig.height = 8, warning = FALSE, message = FALSE}
top <- pa | pb2

bottom <- (pc | pd | pe | pf)

(ff <- top / bottom)
```

Save it
```{r}
ggsave(plot = ff, filename = "../../figures/b_fig_1.pdf", width = 15, height = 8)

ggsave(plot = ff, filename = "../../figures/b_fig_1.png", dpi = 300, width = 15, height = 8)
```

### Supplemental tables from this figure

```{r}
sessionInfo()
```

